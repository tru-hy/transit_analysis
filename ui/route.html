<script type="text/javascript" src="static/js/jquery.js"></script>
<script type="text/javascript" src="static/js/jquery-deparam.js"></script>
<script type="text/javascript" src="static/js/coffee-script.js"></script>

<script type="text/coffeescript" src="static/js/trusas.core.coffee"></script>

<script type="text/javascript" src="static/js/Cesium/Cesium.js"></script>
<link rel="stylesheet" href="static/css/transit_analysis.css" type="text/css" src="static/js/Cesium/Widgets/CesiumWidget/CesiumWidget.css" />

<script type="text/coffeescript" src="static/js/trusas.map.coffee"></script>

<script type="text/javascript" src="/static/js/jquery.flot.js"></script>
<script type="text/javascript" src="/static/js/jquery.flot.crosshair.js"></script>
<script type="text/javascript" src="/static/js/jquery.flot.navigate.js"></script>

<!--<script type="text/javascript" src="static/js/envision.min.js"></script>
<link rel="stylesheet" href="static/css/envision.min.css" type="text/css"/> -->

<script type="text/javascript" src="static/js/underscore.js"></script>

<link rel="stylesheet" href="static/css/transit_analysis.css" type="text/css"/>

<script type="text/coffeescript">
class DataController
	constructor: ->
		@cursor = new TrusasCursor()

		query = $.deparam(window.location.search[1..])
		@shape_promise = $.getJSON \
			"resources/coordinate_shape.json?"+$.param(_.pick(query, 'shape'))

		traces_query = "resources/departure_traces.json"+window.location.search
		@traces_promise = $.getJSON traces_query
			
		@shape_promise.done @_setup_cursor
	
	_setup_cursor: (data) =>
		[lats, lons] = _.zip(data.coordinates...)
		@cursor.accommodateAxisRange _.min(data.distances), _.max(data.distances)
		@pos_to_coords = Trusas.coord_interp data.distances, lats, lons
		@cursorpath = Trusas.rangepath data.distances, lats, lons

		

$ ->
	cursor = new TrusasCursor()
	cursorpath = -> []
	
	ctrl = new DataController()

	ctrl.shape_promise.done (data) ->
		route_map = new Trusas.Map $("#route-map")[0]
		route_map.add_route "default", data.coordinates

		$(ctrl.cursor).on "activeRangeChange", (e, rng) ->
			subpath = ctrl.cursorpath rng...
			extent = Trusas.coords_extent subpath
			route_map.set_extent extent

		$(ctrl.cursor).on "hoverPositionChange", (e, pos) ->
			coords = ctrl.pos_to_coords pos
			if not coords[0]?
				coords = undefined
			route_map.set_hover coords


	###
	traces_promise.done (data) ->
		series = []
		for d in data
			s =
				data: [d.route_distance, d.route_speed]
				color: "rgba(0,0,0,0.1)"

			series.push s
		
		opts =
			container: $("#route-speed")[0],
			data:
				detail: series,
				summary: series
			defaults:
				detail: config:
					yaxis: showLabels: true
				summary: config:
					xaxis: showLabels: true


		series = new envision.templates.TimeSeries opts
		return

		vis = new envision.Visualization()
		graph = new envision.Component
			name: "speeds"
			config:
				'lite-lines':
					lineWidth: 1
					show: true
				selection:
					mode: "x"
				xaxis: showLabels: true
			data: series
			height: "100%"
		
		vis
			.add(graph)
			.render $("#route-speed")[0]

		interact = new envision.Interaction()
		interact
			.group([graph])
			.add(envision.actions.zoom, {})
		

	###
	ctrl.traces_promise.done (data) ->
		drives = []
		
		diff = (x) ->
			(x[i] - x[i-1] for i in [1..x.length-1])

		nulltonan = (x) ->
			for i in [0..x.length]
				if not x[i]?
					x[i] = NaN
			return x

		dist_grid_len = data[0].time_at_distance_grid.length

		dist_bin_width = data[0].distance_bin_width
		dist_grid = (i*dist_bin_width for i in [0..dist_grid_len])
		for d in data
			drive = {}
			#drive.data = _.zip(d.route_distance, d.route_speed)
			t_at_d = nulltonan d.time_at_distance_grid
			drive.data = _.zip(dist_grid[1..], diff t_at_d)
			drive.color = "rgba(0,0,0,0.1)"
			drive.shadowSize = 0
			drives.push drive
		
		timeticks = [0, 1, 5, 10, 15, 30, 60, 120, 300, 600]
		el = $("#route-speed")
		plot = $.plot el, drives,
			zoom: interactive: true
			pan: interactive: true
			yaxis:
				panRange: false
				zoomRange: false
				min: 0.5
				ticks: timeticks
				transform: (x) -> Math.log(x+1)
			xaxis:
				panRange: ctrl.cursor.getAxisRange()
				zoomRange: ctrl.cursor.getAxisRange()
			grid: hoverable: true
			crosshair: mode: 'x'

		update_cursor = ->
			axes = plot.getAxes()
			start = axes.xaxis.min
			end = axes.xaxis.max
			ctrl.cursor.setActiveRange([start, end])
		
		$(el).bind "plotzoom", update_cursor
		$(el).bind "plotpan", update_cursor

		$(el).bind "plothover", (event, pos, item) ->
			ctrl.cursor.setHoverPosition pos.x
		


	
	#data_promise.fail (promise, reason, message) ->
	#	console.log promise, reason, message

	#data_promise.done (data) ->
	#	console.log "DONE", data

</script>

<div id="route-map" style="width: 500px; height: 500px; float: left;"></div>
<div id="route-speed" style="width: 49%; height: 500px; float: left;"></div>
